// ================== LIBRARIES ==================
#include <HardwareSerial.h>
#include <PZEM004Tv30.h>
#include <WiFi.h>
#include <PubSubClient.h>
#include <ArduinoJson.h>

// ================== WIFI & MQTT SETTINGS ==================
const char* ssid = "Ljsport.bdl";
const char* password = "Ljsport06";
const char* mqtt_server = "154.19.37.61";
const int mqtt_port = 1883;
const char* mqtt_user = "";     // Kosongkan jika tidak ada
const char* mqtt_password = ""; // Kosongkan jika tidak ada

// Device ID unik (ubah sesuai kebutuhan)
const char* deviceId = "power-monitor-001";

// Topic base
String topicBase = "iot/monitoring/" + String(deviceId);

// ================== PIN RELAY ==================
#define RELAY1 18
#define RELAY2 19
#define RELAY3 21
#define RELAY4 22
#define RELAY5 23
#define RELAY6 25

// ================== PIN SAKLAR MASTER ==================
#define MASTER_SWITCH_PIN 26

// ================== PIN PZEM004T ==================
#define PZEM_RX_PIN 16
#define PZEM_TX_PIN 17
#define PZEM_ADDR 0x01  // Alamat default PZEM004T

// ================== KONFIGURASI LAMPU (DAYA REAL) ==================
// Daya real berdasarkan pengukuran:
// Lampu "5W" asli: 3.4-3.8W (rata-rata 3.6W)
// Lampu "3W" asli: 2.6-2.8W (rata-rata 2.7W)
struct Lampu {
  int relayPin;
  float wattage;        // Daya REAL lampu dalam watt
  float wattageMin;     // Daya minimum
  float wattageMax;     // Daya maksimum
  bool isInstalled;     // Apakah terpasang lampu
  String type;          // Jenis lampu
  bool isOn;            // Status nyala/mati
  float energyKWH;      // Energi terakumulasi (kWh)
  float powerNow;       // Daya saat ini (W)
  float currentNow;     // Arus saat ini (A)
  unsigned long onTime; // Waktu mulai menyala (ms)
  unsigned long lastUpdate; // Waktu update terakhir
  float totalEnergyToday; // Energi hari ini (kWh)
};

Lampu lampu[6] = {
  // Relay 1: Lampu "5W" (real 3.6W)
  {RELAY1, 3.6, 3.4, 3.8, true, "Lampu 5W (real 3.6W)", false, 0, 0, 0, 0, 0, 0},
  // Relay 2: Lampu "5W" (real 3.6W)
  {RELAY2, 3.6, 3.4, 3.8, true, "Lampu 5W (real 3.6W)", false, 0, 0, 0, 0, 0, 0},
  // Relay 3: Lampu "3W" (real 2.7W)
  {RELAY3, 2.7, 2.6, 2.8, true, "Lampu 3W (real 2.7W)", false, 0, 0, 0, 0, 0, 0},
  // Relay 4: Lampu "5W" (real 3.6W)
  {RELAY4, 3.6, 3.4, 3.8, true, "Lampu 5W (real 3.6W)", false, 0, 0, 0, 0, 0, 0},
  // Relay 5: Tidak terpasang
  {RELAY5, 0.0, 0.0, 0.0, false, "Tidak terpasang", false, 0, 0, 0, 0, 0, 0},
  // Relay 6: Lampu "5W" (real 3.6W)
  {RELAY6, 3.6, 3.4, 3.8, true, "Lampu 5W (real 3.6W)", false, 0, 0, 0, 0, 0, 0}
};

// ================== VARIABLES ==================
int relayPins[6] = {
  RELAY1,
  RELAY2,
  RELAY3,
  RELAY4,
  RELAY5,
  RELAY6
};

// Status relay
bool relayStates[6] = {false, false, false, false, false, false};
bool masterSwitchState = false;
bool lastSwitchState = HIGH;  // Default saklar terbuka (HIGH)
unsigned long lastDebounceTime = 0;
unsigned long debounceDelay = 50;
bool manualControl = false;  // Mode kontrol manual via serial

// Inisialisasi PZEM004T dengan HardwareSerial
PZEM004Tv30 pzem(Serial2, PZEM_RX_PIN, PZEM_TX_PIN, PZEM_ADDR);
float voltage, current, power, energy, frequency, pf;
bool pzemConnected = false;

// Timer untuk monitoring PZEM
unsigned long lastPZEMCheck = 0;
const unsigned long PZEM_CHECK_INTERVAL = 2000; // Periksa setiap 2 detik

// Timer untuk update per-lampu
unsigned long lastLampUpdate = 0;
const unsigned long LAMP_UPDATE_INTERVAL = 1000; // Update per detik

// Timer untuk MQTT publish
unsigned long lastMQTTPublish = 0;
const unsigned long MQTT_PUBLISH_INTERVAL = 5000; // Publish setiap 5 detik

// Variabel untuk tracking hari
int lastDay = -1;
float totalEnergyToday = 0.0;

// ================== MQTT VARIABLES ==================
WiFiClient espClient;
PubSubClient client(espClient);

// ================== SETUP ==================
void setup() {
  Serial.begin(115200);
  
  // Inisialisasi relay
  for (int i = 0; i < 6; i++) {
    pinMode(relayPins[i], OUTPUT);
    digitalWrite(relayPins[i], HIGH); // OFF (ACTIVE LOW)
    relayStates[i] = false;
    lampu[i].isOn = false;
  }
  
  // Inisialisasi saklar master (INPUT_PULLUP)
  pinMode(MASTER_SWITCH_PIN, INPUT_PULLUP);
  
  // Inisialisasi PZEM004T
  Serial2.begin(9600, SERIAL_8N1, PZEM_RX_PIN, PZEM_TX_PIN);
  delay(1000);
  
  // Koneksi WiFi
  setupWiFi();
  
  // Setup MQTT
  client.setServer(mqtt_server, mqtt_port);
  client.setCallback(mqttCallback);
  
  // Set waktu awal
  lastDay = day();
  
  Serial.println("\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  Serial.println("     ESP32 + Relay 6 Channel + PZEM004T + MASTER + MQTT");
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  Serial.println("\nüìä KONFIGURASI LAMPU (DAYA REAL):");
  Serial.println("  Relay 1: Lampu '5W' (real: 3.4-3.8W, avg: 3.6W)");
  Serial.println("  Relay 2: Lampu '5W' (real: 3.4-3.8W, avg: 3.6W)");
  Serial.println("  Relay 3: Lampu '3W' (real: 2.6-2.8W, avg: 2.7W)");
  Serial.println("  Relay 4: Lampu '5W' (real: 3.4-3.8W, avg: 3.6W)");
  Serial.println("  Relay 5: Tidak terpasang");
  Serial.println("  Relay 6: Lampu '5W' (real: 3.4-3.8W, avg: 3.6W)");
  Serial.println("  Total jika semua menyala: 4x3.6W + 1x2.7W = 17.1W");
  Serial.println("\nüì° MQTT CONFIG:");
  Serial.print("  Device ID: "); Serial.println(deviceId);
  Serial.print("  Server: "); Serial.println(mqtt_server);
  Serial.print("  Port: "); Serial.println(mqtt_port);
  Serial.print("  Topic Base: "); Serial.println(topicBase);
  Serial.println("\nüí∞ PERHITUNGAN BIAYA:");
  Serial.println("  ‚Ä¢ Tarif: Rp 1.500 / kWh");
  Serial.println("  ‚Ä¢ Biaya per jam: ¬±Rp 25.65 (jika semua lampu nyala)");
  Serial.println("  ‚Ä¢ Auto KWH update setiap 30 detik");
  Serial.println("\nCommand Relay:");
  Serial.println("  1ON    - Relay 1 ON (jika saklar OPEN)");
  Serial.println("  1OFF   - Relay 1 OFF (jika saklar OPEN)");
  Serial.println("  ...    - Sama untuk relay 2-6");
  Serial.println("\nCommand Monitoring:");
  Serial.println("  LAMP   - Status detail per lampu + KWH");
  Serial.println("  KWH    - Detail KWh konsumsi");
  Serial.println("  COST   - Estimasi biaya");
  Serial.println("  STATUS - Status sistem");
  Serial.println("  MQTT   - Status koneksi MQTT");
  Serial.println("  HELP/? - Menu bantuan");
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
}

// ================== LOOP ==================
void loop() {
  // 1. Cek saklar master (debounced)
  checkMasterSwitch();
  
  // 2. Cek input serial (selalu aktif)
  if (Serial.available()) {
    handleSerialCommand();
  }
  
  // 3. Monitoring PZEM004T secara kontinu (setiap 2 detik)
  if (millis() - lastPZEMCheck >= PZEM_CHECK_INTERVAL) {
    lastPZEMCheck = millis();
    monitorPowerConsumption();
  }
  
  // 4. Update data per lampu (setiap detik) dan hitung KWH
  if (millis() - lastLampUpdate >= LAMP_UPDATE_INTERVAL) {
    lastLampUpdate = millis();
    updateLampData();
    
    // Reset energi harian jika ganti hari
    checkDayChange();
  }
  
  // 5. Handle MQTT connection dan publish data
  if (!client.connected()) {
    reconnectMQTT();
  }
  client.loop();
  
  // 6. Publish data ke MQTT setiap 5 detik
  if (millis() - lastMQTTPublish >= MQTT_PUBLISH_INTERVAL) {
    lastMQTTPublish = millis();
    publishMQTTData();
  }
  
  // 7. Auto display setiap 30 detik (termasuk KWH)
  static unsigned long lastAutoDisplay = 0;
  if (millis() - lastAutoDisplay > 30000) { // Setiap 30 detik
    lastAutoDisplay = millis();
    displayAutoStatus();
  }
  
  delay(10); // Delay kecil untuk stabilisasi
}

// ================== WIFI FUNCTIONS ==================
void setupWiFi() {
  Serial.println();
  Serial.print("Connecting to ");
  Serial.println(ssid);
  
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("");
    Serial.println("WiFi connected");
    Serial.print("IP address: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("");
    Serial.println("WiFi connection failed!");
  }
}

// ================== MQTT FUNCTIONS ==================
void reconnectMQTT() {
  // Loop until we're reconnected
  while (!client.connected()) {
    Serial.print("Attempting MQTT connection...");
    
    // Create client ID
    String clientId = "ESP32-";
    clientId += String(random(0xffff), HEX);
    
    // Attempt to connect
    if (client.connect(clientId.c_str(), mqtt_user, mqtt_password)) {
      Serial.println("connected");
      
      // Subscribe to control topics
      String subscribeTopic = topicBase + "/control";
      client.subscribe(subscribeTopic.c_str());
      
      // Publish connection status
      publishSystemStatus();
      
    } else {
      Serial.print("failed, rc=");
      Serial.print(client.state());
      Serial.println(" try again in 5 seconds");
      delay(5000);
    }
  }
}

void mqttCallback(char* topic, byte* payload, unsigned int length) {
  Serial.print("Message arrived [");
  Serial.print(topic);
  Serial.print("] ");
  
  String message = "";
  for (int i = 0; i < length; i++) {
    message += (char)payload[i];
  }
  Serial.println(message);
  
  // Parse JSON
  StaticJsonDocument<256> doc;
  DeserializationError error = deserializeJson(doc, message);
  
  if (error) {
    Serial.print("JSON parsing failed: ");
    Serial.println(error.c_str());
    return;
  }
  
  // Handle control messages
  String controlTopic = topicBase + "/control";
  if (String(topic) == controlTopic) {
    String command = doc["command"] | "";
    int relayNum = doc["relay"] | 0;
    String action = doc["action"] | "";
    float value = doc["value"] | 0.0;
    
    handleMQTTControl(command, relayNum, action, value);
  }
}

void handleMQTTControl(String command, int relayNum, String action, float value) {
  Serial.print("MQTT Control: ");
  Serial.print("Command="); Serial.print(command);
  Serial.print(", Relay="); Serial.print(relayNum);
  Serial.print(", Action="); Serial.print(action);
  Serial.print(", Value="); Serial.println(value);
  
  // Cek jika saklar master CLOSE
  if (masterSwitchState == LOW) {
    publishJSON("status", "error", "Master switch CLOSE, relay control disabled");
    return;
  }
  
  if (command == "all" || command == "ALL") {
    if (action == "on" || action == "ON") {
      turnAllRelaysON();
      publishJSON("status", "success", "All relays ON via MQTT");
    } 
    else if (action == "off" || action == "OFF") {
      turnAllRelaysOFF();
      publishJSON("status", "success", "All relays OFF via MQTT");
    }
  }
  else if (relayNum >= 1 && relayNum <= 6) {
    if (action == "on" || action == "ON") {
      controlRelay(relayNum, true);
      publishJSON("relay", "on", relayNum);
    } 
    else if (action == "off" || action == "OFF") {
      controlRelay(relayNum, false);
      publishJSON("relay", "off", relayNum);
    }
    else if (action == "toggle") {
      bool currentState = relayStates[relayNum - 1];
      controlRelay(relayNum, !currentState);
      publishJSON("relay", "toggle", relayNum);
    }
  }
}

void publishJSON(String type, String status, float value) {
  StaticJsonDocument<256> doc;
  doc["type"] = type;
  doc["status"] = status;
  doc["value"] = value;
  
  String jsonString;
  serializeJson(doc, jsonString);
  
  String topic = topicBase + "/" + type;
  client.publish(topic.c_str(), jsonString.c_str());
}

void publishJSON(String type, String status, int value) {
  publishJSON(type, status, (float)value);
}

void publishJSON(String type, String status, String message) {
  StaticJsonDocument<256> doc;
  doc["type"] = type;
  doc["status"] = status;
  doc["message"] = message;
  doc["value"] = 0.0;
  
  String jsonString;
  serializeJson(doc, jsonString);
  
  String topic = topicBase + "/" + type;
  client.publish(topic.c_str(), jsonString.c_str());
}

void publishSystemStatus() {
  StaticJsonDocument<256> doc;
  doc["type"] = "system";
  doc["status"] = "online";
  doc["deviceId"] = deviceId;
  doc["ip"] = WiFi.localIP().toString();
  doc["message"] = "Device connected";
  doc["value"] = 1.0;
  
  String jsonString;
  serializeJson(doc, jsonString);
  
  String topic = topicBase + "/system";
  client.publish(topic.c_str(), jsonString.c_str());
}

void publishMQTTData() {
  if (!client.connected()) return;
  
  // 1. Publish system data
  StaticJsonDocument<512> systemDoc;
  systemDoc["type"] = "system";
  systemDoc["status"] = "online";
  systemDoc["deviceId"] = deviceId;
  systemDoc["uptime"] = millis() / 1000;
  systemDoc["wifiRssi"] = WiFi.RSSI();
  systemDoc["freeHeap"] = ESP.getFreeHeap();
  
  String systemJson;
  serializeJson(systemDoc, systemJson);
  client.publish((topicBase + "/system").c_str(), systemJson.c_str());
  
  // 2. Publish sensor data (PZEM)
  if (pzemConnected) {
    // Power data
    StaticJsonDocument<256> powerDoc;
    powerDoc["type"] = "power";
    powerDoc["status"] = "active";
    powerDoc["value"] = power;
    powerDoc["unit"] = "W";
    
    String powerJson;
    serializeJson(powerDoc, powerJson);
    client.publish((topicBase + "/power").c_str(), powerJson.c_str());
    
    // Voltage data
    StaticJsonDocument<256> voltageDoc;
    voltageDoc["type"] = "voltage";
    voltageDoc["status"] = "active";
    voltageDoc["value"] = voltage;
    voltageDoc["unit"] = "V";
    
    String voltageJson;
    serializeJson(voltageDoc, voltageJson);
    client.publish((topicBase + "/voltage").c_str(), voltageJson.c_str());
    
    // Current data
    StaticJsonDocument<256> currentDoc;
    currentDoc["type"] = "current";
    currentDoc["status"] = "active";
    currentDoc["value"] = current;
    currentDoc["unit"] = "A";
    
    String currentJson;
    serializeJson(currentDoc, currentJson);
    client.publish((topicBase + "/current").c_str(), currentJson.c_str());
    
    // Energy data
    StaticJsonDocument<256> energyDoc;
    energyDoc["type"] = "energy";
    energyDoc["status"] = "active";
    energyDoc["value"] = energy;
    energyDoc["unit"] = "kWh";
    
    String energyJson;
    serializeJson(energyDoc, energyJson);
    client.publish((topicBase + "/energy").c_str(), energyJson.c_str());
  }
  
  // 3. Publish master switch status
  int switchState = digitalRead(MASTER_SWITCH_PIN);
  StaticJsonDocument<256> switchDoc;
  switchDoc["type"] = "master";
  switchDoc["status"] = (switchState == LOW) ? "on" : "off";
  switchDoc["value"] = (switchState == LOW) ? 1.0 : 0.0;
  
  String switchJson;
  serializeJson(switchDoc, switchJson);
  client.publish((topicBase + "/master").c_str(), switchJson.c_str());
  
  // 4. Publish relay status
  StaticJsonDocument<512> relayDoc;
  relayDoc["type"] = "relay";
  JsonArray relays = relayDoc.createNestedArray("relays");
  
  for (int i = 0; i < 6; i++) {
    JsonObject relay = relays.createNestedObject();
    relay["id"] = i + 1;
    relay["status"] = (digitalRead(relayPins[i]) == LOW) ? "on" : "off";
    relay["value"] = (digitalRead(relayPins[i]) == LOW) ? 1.0 : 0.0;
    if (lampu[i].isInstalled) {
      relay["type"] = lampu[i].type;
      relay["wattage"] = lampu[i].wattage;
    }
  }
  
  String relayJson;
  serializeJson(relayDoc, relayJson);
  client.publish((topicBase + "/relay").c_str(), relayJson.c_str());
  
  // 5. Publish lamp data per lampu
  float totalLampPower = 0;
  float totalLampEnergy = 0;
  int lampsOn = 0;
  
  StaticJsonDocument<1024> lampDoc;
  lampDoc["type"] = "lamp";
  JsonArray lamps = lampDoc.createNestedArray("lamps");
  
  for (int i = 0; i < 6; i++) {
    if (lampu[i].isInstalled) {
      JsonObject lamp = lamps.createNestedObject();
      lamp["id"] = i + 1;
      lamp["type"] = lampu[i].type;
      lamp["wattage"] = lampu[i].wattage;
      lamp["status"] = lampu[i].isOn ? "on" : "off";
      lamp["power"] = lampu[i].powerNow;
      lamp["current"] = lampu[i].currentNow;
      lamp["energy"] = lampu[i].energyKWH;
      lamp["energy_today"] = lampu[i].totalEnergyToday;
      lamp["value"] = lampu[i].isOn ? lampu[i].wattage : 0.0;
      
      if (lampu[i].isOn) {
        lampsOn++;
        totalLampPower += lampu[i].wattage;
      }
      totalLampEnergy += lampu[i].energyKWH;
    }
  }
  
  lampDoc["total_power"] = totalLampPower;
  lampDoc["total_energy"] = totalLampEnergy;
  lampDoc["lamps_on"] = lampsOn;
  lampDoc["total_lamps"] = 5;
  
  String lampJson;
  serializeJson(lampDoc, lampJson);
  client.publish((topicBase + "/lamp").c_str(), lampJson.c_str());
  
  // 6. Publish summary data
  StaticJsonDocument<512> summaryDoc;
  summaryDoc["type"] = "summary";
  summaryDoc["lamps_on"] = lampsOn;
  summaryDoc["lamps_total"] = 5;
  summaryDoc["power_total"] = totalLampPower;
  summaryDoc["power_pzem"] = pzemConnected ? power : 0.0;
  summaryDoc["energy_total"] = totalLampEnergy;
  summaryDoc["energy_today"] = totalEnergyToday;
  summaryDoc["voltage"] = pzemConnected ? voltage : 0.0;
  summaryDoc["current"] = pzemConnected ? current : 0.0;
  
  // Calculate cost
  float cost = totalLampEnergy * 1500;
  float costToday = totalEnergyToday * 1500;
  summaryDoc["cost_total"] = cost;
  summaryDoc["cost_today"] = costToday;
  
  String summaryJson;
  serializeJson(summaryDoc, summaryJson);
  client.publish((topicBase + "/summary").c_str(), summaryJson.c_str());
  
  // 7. Publish individual lamp status (optional, for specific queries)
  for (int i = 0; i < 6; i++) {
    if (lampu[i].isInstalled) {
      StaticJsonDocument<256> indvDoc;
      indvDoc["type"] = "lamp_" + String(i+1);
      indvDoc["id"] = i + 1;
      indvDoc["status"] = lampu[i].isOn ? "on" : "off";
      indvDoc["value"] = lampu[i].isOn ? lampu[i].wattage : 0.0;
      indvDoc["power"] = lampu[i].powerNow;
      indvDoc["energy"] = lampu[i].energyKWH;
      
      String indvJson;
      serializeJson(indvDoc, indvJson);
      client.publish((topicBase + "/lamp/" + String(i+1)).c_str(), indvJson.c_str());
    }
  }
}

// ================== FUNCTIONS ==================

// Fungsi update data per lampu dan hitung KWH
void updateLampData() {
  unsigned long currentTime = millis();
  
  for (int i = 0; i < 6; i++) {
    if (lampu[i].isInstalled) {
      // Update status ON/OFF berdasarkan pin relay
      bool relayState = (digitalRead(lampu[i].relayPin) == LOW);
      bool wasOn = lampu[i].isOn;
      lampu[i].isOn = relayState;
      
      // Jika lampu menyala, hitung energi
      if (lampu[i].isOn) {
        unsigned long elapsedTime = currentTime - lampu[i].lastUpdate;
        
        if (lampu[i].lastUpdate > 0 && elapsedTime > 0) {
          // Hitung energi: (Watt * jam) / 1000
          float hours = elapsedTime / 3600000.0; // ms ke jam
          float energyConsumed = (lampu[i].wattage * hours) / 1000.0; // kWh
          
          // Tambahkan ke total energi
          lampu[i].energyKWH += energyConsumed;
          lampu[i].totalEnergyToday += energyConsumed;
          totalEnergyToday += energyConsumed;
        }
        
        lampu[i].lastUpdate = currentTime;
        lampu[i].powerNow = lampu[i].wattage;
        lampu[i].currentNow = lampu[i].wattage / voltage;
      } else {
        lampu[i].powerNow = 0;
        lampu[i].currentNow = 0;
        if (wasOn) {
          // Jika baru saja dimatikan, masih update lastUpdate untuk konsistensi
          lampu[i].lastUpdate = currentTime;
        }
      }
    }
  }
}

// Cek pergantian hari
void checkDayChange() {
  int currentDay = day(); // Fungsi day() dari Time library atau implementasi sendiri
  
  if (currentDay != lastDay) {
    Serial.println("\nüìÖ HARI BARU! Reset energi harian...");
    
    // Reset energi harian
    for (int i = 0; i < 6; i++) {
      lampu[i].totalEnergyToday = 0;
    }
    totalEnergyToday = 0;
    lastDay = currentDay;
    
    // Publish ke MQTT
    if (client.connected()) {
      publishJSON("system", "info", "New day: Energy reset");
    }
    
    Serial.println("‚úì Energi harian telah direset");
  }
}

// Fungsi sederhana untuk mendapatkan hari (jika tidak ada Time library)
int day() {
  // Implementasi sederhana: konversi millis() ke hari
  // Untuk ESP32 sebaiknya gunakan RTC atau NTP
  return (millis() / 86400000); // 86400000 ms = 1 hari
}

// Fungsi untuk cek saklar master dengan debounce
void checkMasterSwitch() {
  int reading = digitalRead(MASTER_SWITCH_PIN);
  
  // Debounce logic
  if (reading != lastSwitchState) {
    lastDebounceTime = millis();
  }
  
  if ((millis() - lastDebounceTime) > debounceDelay) {
    // Jika saklar berubah state
    if (reading != masterSwitchState) {
      masterSwitchState = reading;
      
      // Jika saklar CLOSE (LOW) - Hidupkan semua relay
      if (masterSwitchState == LOW) {
        turnAllRelaysON();
        manualControl = false;
        Serial.println("\nüîå SAKLAR MASTER: CLOSE");
        Serial.println("‚úì Semua relay ON (dikontrol saklar)");
        Serial.println("üìä KWH tracking: AKTIF real-time");
        
        // Publish ke MQTT
        if (client.connected()) {
          publishJSON("master", "on", "Master switch CLOSED - All relays ON");
        }
        
        Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
      }
      // Jika saklar OPEN (HIGH) - Matikan semua relay
      else if (masterSwitchState == HIGH) {
        turnAllRelaysOFF();
        manualControl = false;
        Serial.println("\nüîå SAKLAR MASTER: OPEN");
        Serial.println("‚úì Semua relay OFF (dikontrol saklar)");
        Serial.println("üìä KWH tracking: AKTIF real-time");
        
        // Publish ke MQTT
        if (client.connected()) {
          publishJSON("master", "off", "Master switch OPEN - All relays OFF");
        }
        
        Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
      }
    }
  }
  
  lastSwitchState = reading;
}

// Fungsi untuk menghidupkan semua relay
void turnAllRelaysON() {
  for (int i = 0; i < 6; i++) {
    digitalWrite(relayPins[i], LOW); // Relay ON (ACTIVE LOW)
    relayStates[i] = true;
    if (lampu[i].isInstalled) {
      lampu[i].isOn = true;
      lampu[i].onTime = millis();
      lampu[i].lastUpdate = millis();
    }
  }
}

// Fungsi untuk mematikan semua relay
void turnAllRelaysOFF() {
  for (int i = 0; i < 6; i++) {
    digitalWrite(relayPins[i], HIGH); // Relay OFF (ACTIVE LOW)
    relayStates[i] = false;
    if (lampu[i].isInstalled && lampu[i].isOn) {
      lampu[i].isOn = false;
    }
  }
}

// Fungsi untuk mengontrol relay individual
void controlRelay(int relayNum, bool state) {
  if (relayNum >= 1 && relayNum <= 6) {
    if (masterSwitchState == LOW) {
      String msg = "‚ö†Ô∏è  Saklar master CLOSE! Relay dikontrol saklar.";
      Serial.println(msg);
      
      // Publish ke MQTT
      if (client.connected()) {
        publishJSON("status", "error", "Master switch CLOSE, relay control disabled");
      }
      return;
    }
    
    digitalWrite(relayPins[relayNum - 1], state ? LOW : HIGH);
    relayStates[relayNum - 1] = state;
    
    // Update data lampu
    if (lampu[relayNum - 1].isInstalled) {
      if (state) {
        lampu[relayNum - 1].isOn = true;
        lampu[relayNum - 1].onTime = millis();
        lampu[relayNum - 1].lastUpdate = millis();
        String msg = "üí° Lampu " + String(relayNum) + " (" + lampu[relayNum - 1].type + ") ON ‚ö° | Daya: " + String(lampu[relayNum - 1].wattage) + "W";
        Serial.println(msg);
      } else {
        lampu[relayNum - 1].isOn = false;
        String msg = "üí° Lampu " + String(relayNum) + " (" + lampu[relayNum - 1].type + ") OFF ‚ùå | Total KWh: " + String(lampu[relayNum - 1].energyKWH, 6);
        Serial.println(msg);
      }
    }
  }
}

// Fungsi monitoring daya real-time
void monitorPowerConsumption() {
  // Baca data dari PZEM
  float currentVoltage = pzem.voltage();
  float currentCurrent = pzem.current();
  float currentPower = pzem.power();
  float currentEnergy = pzem.energy();
  
  // Simpan data untuk ditampilkan nanti
  if (!isnan(currentVoltage)) {
    voltage = currentVoltage;
    current = currentCurrent;
    power = currentPower;
    energy = currentEnergy;
    pzemConnected = true;
  } else {
    pzemConnected = false;
  }
}

// ================== SERIAL COMMAND HANDLER ==================

void handleSerialCommand() {
  String cmd = Serial.readStringUntil('\n');
  cmd.trim();
  cmd.toUpperCase();
  
  // Cek command relay individual
  if (cmd.length() >= 3) {
    char firstChar = cmd.charAt(0);
    if (firstChar >= '1' && firstChar <= '6') {
      int relayNum = String(firstChar).toInt();
      String action = cmd.substring(1);
      
      if (masterSwitchState == LOW) {
        Serial.println("‚ö†Ô∏è  Saklar master CLOSE! Relay dikontrol saklar.");
        return;
      }
      
      if (action == "ON") {
        controlRelay(relayNum, true);
      } 
      else if (action == "OFF") {
        controlRelay(relayNum, false);
      } else {
        Serial.println("‚úó Format salah! Gunakan: 1ON, 1OFF, 2ON, dll.");
      }
      return;
    }
  }
  
  // Command untuk semua relay ON
  if (cmd == "ALL ON") {
    if (masterSwitchState == LOW) {
      Serial.println("‚ö†Ô∏è  Saklar master CLOSE! Relay dikontrol saklar.");
      return;
    }
    turnAllRelaysON();
    Serial.println("‚úì Semua relay ON (via serial)");
  }
  
  // Command untuk semua relay OFF
  else if (cmd == "ALL OFF") {
    if (masterSwitchState == LOW) {
      Serial.println("‚ö†Ô∏è  Saklar master CLOSE! Relay dikontrol saklar.");
      return;
    }
    turnAllRelaysOFF();
    Serial.println("‚úì Semua relay OFF (via serial)");
  }
  
  // Command untuk status lampu + KWH
  else if (cmd == "LAMP" || cmd == "LAMPS") {
    showLampStatus();
  }
  
  // Command untuk detail KWH
  else if (cmd == "KWH" || cmd == "ENERGY") {
    showEnergyDetail();
  }
  
  // Command untuk estimasi biaya
  else if (cmd == "COST" || cmd == "BIAYA") {
    showCostEstimation();
  }
  
  // Command untuk status sistem
  else if (cmd == "STATUS") {
    showSystemStatus();
  }
  
  // Command untuk status MQTT
  else if (cmd == "MQTT") {
    showMQTTStatus();
  }
  
  // Command untuk bantuan
  else if (cmd == "HELP" || cmd == "?") {
    showHelp();
  }
  
  // Command untuk reset KWH total
  else if (cmd == "RESET KWH") {
    resetEnergyData();
  }
  
  // Command untuk publish manual ke MQTT
  else if (cmd == "PUBLISH") {
    publishMQTTData();
    Serial.println("‚úì Manual publish to MQTT");
  }
  
  else {
    Serial.println("‚úó Command tidak dikenali! Ketik HELP untuk bantuan.");
  }
}

// ================== FUNGSI DISPLAY ==================

// Auto status update setiap 30 detik (DENGAN KWH)
void displayAutoStatus() {
  static int updateCount = 0;
  updateCount++;
  
  // Hitung total dari lampu yang menyala
  int lampsOn = 0;
  float totalLampPower = 0;
  float totalLampEnergy = 0;
  
  for (int i = 0; i < 6; i++) {
    if (lampu[i].isInstalled && lampu[i].isOn) {
      lampsOn++;
      totalLampPower += lampu[i].wattage;
    }
    if (lampu[i].isInstalled) {
      totalLampEnergy += lampu[i].energyKWH;
    }
  }
  
  Serial.println("\n______ AUTO STATUS UPDATE ______");
  Serial.println("Update #" + String(updateCount) + " | " + String(millis()/1000) + " seconds");
  
  // Status saklar
  int switchState = digitalRead(MASTER_SWITCH_PIN);
  Serial.println("‚úî Saklar: " + String(switchState == LOW ? "CLOSE" : "OPEN"));
  
  // Data daya dari PZEM
  if (pzemConnected) {
    Serial.print("‚úî Daya: " + String(power, 1) + " W | ");
    Serial.print("V: " + String(voltage, 1) + " V | ");
    Serial.println("I: " + String(current, 3) + " A");
  }
  
  // Status relay
  Serial.println("‚úî Relay: " + String(lampsOn) + "/5 LAMPU ON");
  
  // KWH DATA - SELALU DITAMPILKAN
  Serial.println("\n--- KWH CONSUMPTION ---");
  Serial.println("Total KWh Semua Lampu: " + String(totalLampEnergy, 6) + " kWh");
  Serial.println("KWh Hari Ini: " + String(totalEnergyToday, 6) + " kWh");
  
  // Estimasi biaya
  float cost = totalLampEnergy * 1500;
  Serial.println("Estimasi Biaya Total: Rp " + String(cost, 2));
  
  // Per lampu summary
  if (lampsOn > 0) {
    Serial.println("\n--- LAMPU YANG MENYALA ---");
    for (int i = 0; i < 6; i++) {
      if (lampu[i].isInstalled && lampu[i].isOn) {
        Serial.print("  Relay " + String(i+1) + ": " + String(lampu[i].wattage) + "W");
        Serial.println(" | KWh: " + String(lampu[i].energyKWH, 6));
      }
    }
  }
  
  // MQTT Status
  Serial.print("üì° MQTT: ");
  Serial.println(client.connected() ? "TERHUBUNG ‚úì" : "TIDAK TERHUBUNG ‚úó");
  
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
}

// Tampilkan status MQTT
void showMQTTStatus() {
  Serial.println("\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MQTT STATUS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  
  Serial.println("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
  Serial.println("‚ïë                   MQTT STATUS                    ‚ïë");
  Serial.println("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
  
  Serial.print("‚ïë Status Koneksi: ");
  if (client.connected()) {
    Serial.println("TERHUBUNG ‚úì                  ‚ïë");
  } else {
    Serial.println("TIDAK TERHUBUNG ‚úó            ‚ïë");
  }
  
  Serial.println("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
  Serial.print("‚ïë Device ID: "); Serial.print(deviceId);
  Serial.println("                      ‚ïë");
  Serial.print("‚ïë Topic Base: "); Serial.print(topicBase);
  Serial.println("           ‚ïë");
  Serial.print("‚ïë Server: "); Serial.print(mqtt_server);
  Serial.println("                       ‚ïë");
  Serial.print("‚ïë Port: "); Serial.print(mqtt_port);
  Serial.println("                                  ‚ïë");
  
  Serial.println("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
  Serial.println("‚ïë TOPICS:                                          ‚ïë");
  Serial.println("‚ïë ‚Ä¢ iot/monitoring/{deviceId}/system              ‚ïë");
  Serial.println("‚ïë ‚Ä¢ iot/monitoring/{deviceId}/power               ‚ïë");
  Serial.println("‚ïë ‚Ä¢ iot/monitoring/{deviceId}/voltage             ‚ïë");
  Serial.println("‚ïë ‚Ä¢ iot/monitoring/{deviceId}/current             ‚ïë");
  Serial.println("‚ïë ‚Ä¢ iot/monitoring/{deviceId}/energy              ‚ïë");
  Serial.println("‚ïë ‚Ä¢ iot/monitoring/{deviceId}/relay               ‚ïë");
  Serial.println("‚ïë ‚Ä¢ iot/monitoring/{deviceId}/lamp                ‚ïë");
  Serial.println("‚ïë ‚Ä¢ iot/monitoring/{deviceId}/summary             ‚ïë");
  Serial.println("‚ïë ‚Ä¢ iot/monitoring/{deviceId}/master              ‚ïë");
  
  Serial.println("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
  Serial.println("‚ïë SUBSCRIBE TOPIC:                                 ‚ïë");
  Serial.println("‚ïë ‚Ä¢ iot/monitoring/{deviceId}/control             ‚ïë");
  
  Serial.println("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
  Serial.println("‚ïë PUBLISH INTERVAL: 5 detik                        ‚ïë");
  Serial.println("‚ïë PAYLOAD FORMAT: JSON                             ‚ïë");
  
  Serial.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
  
  Serial.println("\nüì° FORMAT KONTROL VIA MQTT:");
  Serial.println("  Topic: iot/monitoring/{deviceId}/control");
  Serial.println("  Payload (JSON):");
  Serial.println("  {\"command\":\"all\", \"action\":\"on\"}");
  Serial.println("  {\"relay\":1, \"action\":\"on\"}");
  Serial.println("  {\"relay\":2, \"action\":\"off\"}");
  Serial.println("  {\"relay\":3, \"action\":\"toggle\"}");
  
  Serial.println("\nüì° FORMAT DATA VIA MQTT:");
  Serial.println("  Example payload:");
  Serial.println("  {\"type\":\"power\",\"status\":\"active\",\"value\":25.5}");
  Serial.println("  {\"type\":\"lamp\",\"status\":\"on\",\"value\":3.6}");
  
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
}

// Tampilkan status lampu detail
void showLampStatus() {
  Serial.println("\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATUS LAMPU + KWH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  
  float totalPower = 0;
  float totalEnergy = 0;
  int lampsOn = 0;
  
  for (int i = 0; i < 6; i++) {
    if (lampu[i].isInstalled) {
      String status = lampu[i].isOn ? "ON ‚ö°" : "OFF ‚ùå";
      
      Serial.print("Relay " + String(i+1) + ": " + status);
      Serial.print(" | " + lampu[i].type);
      Serial.print(" | Daya: " + String(lampu[i].wattage, 1) + "W");
      Serial.print(" | Arus: " + String(lampu[i].currentNow, 3) + "A");
      Serial.println(" | KWh: " + String(lampu[i].energyKWH, 6));
      
      if (lampu[i].isOn) {
        lampsOn++;
        totalPower += lampu[i].wattage;
      }
      totalEnergy += lampu[i].energyKWH;
    }
  }
  
  Serial.println("\n--- SUMMARY ---");
  Serial.println("Lampu Menyala: " + String(lampsOn) + "/5");
  Serial.println("Total Daya: " + String(totalPower, 1) + " W");
  Serial.println("Total KWh: " + String(totalEnergy, 6) + " kWh");
  Serial.println("KWh Hari Ini: " + String(totalEnergyToday, 6) + " kWh");
  
  // Estimasi biaya
  float cost = totalEnergy * 1500;
  float dailyCost = totalEnergyToday * 1500;
  Serial.println("Estimasi Biaya Total: Rp " + String(cost, 2));
  Serial.println("Biaya Hari Ini: Rp " + String(dailyCost, 2));
  
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
}

// Tampilkan detail energi
void showEnergyDetail() {
  Serial.println("\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DETAIL KONSUMSI ENERGI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  
  float totalEnergy = 0;
  
  Serial.println("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
  Serial.println("‚ïë                     KWH PER LAMPU                            ‚ïë");
  Serial.println("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
  Serial.println("‚ïë Relay  Jenis Lampu        Daya   Status    KWh Total         ‚ïë");
  Serial.println("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
  
  for (int i = 0; i < 6; i++) {
    if (lampu[i].isInstalled) {
      String status = lampu[i].isOn ? "ON" : "OFF";
      Serial.printf("‚ïë %2d    %-20s %5.1fW  %-6s  %12.6f kWh ‚ïë\n",
                    i+1,
                    lampu[i].type.c_str(),
                    lampu[i].wattage,
                    status.c_str(),
                    lampu[i].energyKWH);
      totalEnergy += lampu[i].energyKWH;
    }
  }
  
  Serial.println("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
  Serial.printf("‚ïë TOTAL KWH: %42.6f kWh ‚ïë\n", totalEnergy);
  Serial.printf("‚ïë KWH HARI INI: %40.6f kWh ‚ïë\n", totalEnergyToday);
  
  // Estimasi biaya
  float cost = totalEnergy * 1500;
  float dailyCost = totalEnergyToday * 1500;
  Serial.printf("‚ïë BIAYA TOTAL: Rp %36.0f ‚ïë\n", cost);
  Serial.printf("‚ïë BIAYA HARI INI: Rp %34.0f ‚ïë\n", dailyCost);
  
  Serial.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
  
  // Info perhitungan
  Serial.println("\nüí° INFO PERHITUNGAN:");
  Serial.println("  ‚Ä¢ Daya lampu berdasarkan pengukuran real");
  Serial.println("  ‚Ä¢ 1 kWh = 1000 Watt selama 1 jam");
  Serial.println("  ‚Ä¢ Tarif listrik: Rp 1.500 / kWh");
  Serial.println("  ‚Ä¢ KWh update real-time setiap detik");
  
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
}

// Tampilkan estimasi biaya
void showCostEstimation() {
  Serial.println("\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ESTIMASI BIAYA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  
  float totalEnergy = 0;
  for (int i = 0; i < 6; i++) {
    if (lampu[i].isInstalled) {
      totalEnergy += lampu[i].energyKWH;
    }
  }
  
  // Hitung biaya
  float costTotal = totalEnergy * 1500;
  float costToday = totalEnergyToday * 1500;
  
  // Estimasi per jam jika semua lampu menyala
  float powerAllOn = (4 * 3.6) + 2.7; // 4 lampu 3.6W + 1 lampu 2.7W
  float costPerHour = (powerAllOn / 1000) * 1500;
  float costPerDay = costPerHour * 24;
  float costPerMonth = costPerDay * 30;
  
  Serial.println("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
  Serial.println("‚ïë               ESTIMASI BIAYA LISTRIK                 ‚ïë");
  Serial.println("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
  Serial.printf("‚ïë TOTAL KWH TERPAKAI  : %10.6f kWh                 ‚ïë\n", totalEnergy);
  Serial.printf("‚ïë KWH HARI INI        : %10.6f kWh                 ‚ïë\n", totalEnergyToday);
  Serial.println("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
  Serial.printf("‚ïë BIAYA TOTAL         : Rp %10.0f                  ‚ïë\n", costTotal);
  Serial.printf("‚ïë BIAYA HARI INI      : Rp %10.0f                  ‚ïë\n", costToday);
  Serial.println("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
  Serial.println("‚ïë         ESTIMASI JIKA SEMUA LAMPU MENYALA:           ‚ïë");
  Serial.printf("‚ïë ‚Ä¢ Per Jam           : Rp %5.2f                    ‚ïë\n", costPerHour);
  Serial.printf("‚ïë ‚Ä¢ Per Hari (24 jam) : Rp %5.2f                    ‚ïë\n", costPerDay);
  Serial.printf("‚ïë ‚Ä¢ Per Bulan (30 hr) : Rp %7.0f                  ‚ïë\n", costPerMonth);
  Serial.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
  
  Serial.println("\nüí° CATATAN:");
  Serial.println("  ‚Ä¢ Berdasarkan tarif Rp 1.500 / kWh");
  Serial.println("  ‚Ä¢ Daya real lampu: '5W'=3.6W, '3W'=2.7W");
  Serial.println("  ‚Ä¢ Estimasi maksimal jika semua lampu menyala 24 jam");
  
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
}

// Tampilkan status sistem
void showSystemStatus() {
  Serial.println("\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SYSTEM STATUS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  
  int switchState = digitalRead(MASTER_SWITCH_PIN);
  Serial.print("üîå Saklar Master: ");
  Serial.println(switchState == LOW ? "CLOSE (Semua relay ON)" : "OPEN");
  
  Serial.print("üìä PZEM004T: ");
  Serial.println(pzemConnected ? "TERHUBUNG ‚úì" : "TIDAK TERHUBUNG ‚úó");
  
  Serial.print("üì° MQTT: ");
  Serial.println(client.connected() ? "TERHUBUNG ‚úì" : "TIDAK TERHUBUNG ‚úó");
  
  if (client.connected()) {
    Serial.print("  Device ID: "); Serial.println(deviceId);
    Serial.print("  Topic Base: "); Serial.println(topicBase);
  }
  
  // Hitung lampu yang menyala
  int lampsOn = 0;
  float totalLampPower = 0;
  float totalEnergy = 0;
  
  for (int i = 0; i < 6; i++) {
    if (lampu[i].isInstalled && lampu[i].isOn) {
      lampsOn++;
      totalLampPower += lampu[i].wattage;
    }
    if (lampu[i].isInstalled) {
      totalEnergy += lampu[i].energyKWH;
    }
  }
  
  Serial.println("\n--- STATUS LAMPU ---");
  Serial.println("Lampu Menyala: " + String(lampsOn) + "/5");
  Serial.println("Total Daya Lampu: " + String(totalLampPower, 1) + " W");
  
  if (pzemConnected) {
    Serial.println("\n--- DATA PZEM ---");
    Serial.println("Daya Terukur: " + String(power, 1) + " W");
    Serial.println("Tegangan: " + String(voltage, 1) + " V");
    Serial.println("Arus: " + String(current, 3) + " A");
  }
  
  Serial.println("\n--- KWH ---");
  Serial.println("Total KWh: " + String(totalEnergy, 6));
  Serial.println("KWh Hari Ini: " + String(totalEnergyToday, 6));
  
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
}

// Reset data energi
void resetEnergyData() {
  Serial.println("\n‚ö†Ô∏è  RESET DATA ENERGI");
  Serial.print("Reset SEMUA data KWh? (YA/TIDAK): ");
  
  unsigned long startTime = millis();
  while (millis() - startTime < 5000) {
    if (Serial.available()) {
      String confirm = Serial.readStringUntil('\n');
      confirm.trim();
      confirm.toUpperCase();
      
      if (confirm == "YA" || confirm == "Y") {
        for (int i = 0; i < 6; i++) {
          lampu[i].energyKWH = 0;
          lampu[i].totalEnergyToday = 0;
        }
        totalEnergyToday = 0;
        Serial.println("\n‚úì SEMUA data KWh telah direset!");
        
        // Publish ke MQTT
        if (client.connected()) {
          publishJSON("system", "info", "All energy data reset");
        }
        return;
      } else {
        Serial.println("\n‚úó Reset dibatalkan.");
        return;
      }
    }
    delay(10);
  }
  Serial.println("\n‚úó Timeout. Reset dibatalkan.");
}

// Tampilkan bantuan
void showHelp() {
  Serial.println("\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELP MENU ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  Serial.println("KONFIGURASI DAYA REAL:");
  Serial.println("  ‚Ä¢ Lampu '5W': 3.4-3.8W (avg 3.6W)");
  Serial.println("  ‚Ä¢ Lampu '3W': 2.6-2.8W (avg 2.7W)");
  
  Serial.println("\nCOMMAND KONTROL:");
  Serial.println("  1ON-6ON    - Relay ON (jika saklar OPEN)");
  Serial.println("  1OFF-6OFF  - Relay OFF (jika saklar OPEN)");
  Serial.println("  ALL ON     - Semua relay ON");
  Serial.println("  ALL OFF    - Semua relay OFF");
  
  Serial.println("\nCOMMAND MONITORING (KWH real-time):");
  Serial.println("  LAMP       - Status lampu + KWH");
  Serial.println("  KWH        - Detail konsumsi energi");
  Serial.println("  COST       - Estimasi biaya");
  Serial.println("  STATUS     - Status sistem");
  Serial.println("  MQTT       - Status koneksi MQTT");
  Serial.println("  PUBLISH    - Manual publish ke MQTT");
  Serial.println("  RESET KWH  - Reset data energi");
  Serial.println("  HELP       - Menu bantuan");
  
  Serial.println("\nüì° MQTT FORMAT:");
  Serial.println("  Topic: iot/monitoring/{deviceId}/[type]");
  Serial.println("  Payload: {\"type\":\"[type]\",\"status\":\"[status]\",\"value\":[value]}");
  Serial.println("  Example: {\"type\":\"power\",\"status\":\"active\",\"value\":25.5}");
  
  Serial.println("\nüì° MQTT CONTROL:");
  Serial.println("  Topic: iot/monitoring/{deviceId}/control");
  Serial.println("  Payload: {\"command\":\"all\", \"action\":\"on\"}");
  Serial.println("  Payload: {\"relay\":1, \"action\":\"on\"}");
  
  Serial.println("\nFITUR:");
  Serial.println("  ‚Ä¢ KWH update setiap 30 detik (auto)");
  Serial.println("  ‚Ä¢ Tracking energi per lampu real-time");
  Serial.println("  ‚Ä¢ Estimasi biaya otomatis");
  Serial.println("  ‚Ä¢ Reset harian otomatis");
  Serial.println("  ‚Ä¢ MQTT publish setiap 5 detik (JSON format)");
  
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
}