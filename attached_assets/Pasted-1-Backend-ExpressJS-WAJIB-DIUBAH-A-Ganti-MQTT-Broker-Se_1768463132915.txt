1ï¸âƒ£ Backend (ExpressJS) â€” WAJIB DIUBAH
âœ… A. Ganti MQTT Broker

Sebelumnya (public broker):

const mqttClient = mqtt.connect("mqtt://broker.hivemq.com");


Diubah menjadi (broker VPS sendiri):

const mqttClient = mqtt.connect("mqtt://localhost:1883", {
  reconnectPeriod: 5000,
  connectTimeout: 30 * 1000,
});


ðŸ“Œ Kenapa diubah?

Supaya backend terhubung ke Mosquitto di VPS

Data dari ESP32 tidak lewat broker publik

Lebih aman & stabil

âœ… B. Subscribe topic MQTT (monitoring)

Pastikan backend subscribe ke topic ESP32:

mqttClient.on("connect", () => {
  mqttClient.subscribe("iot/monitoring/#");
});


ðŸ“Œ # artinya semua device:

iot/monitoring/1

iot/monitoring/2

dst

âœ… C. Handle data MQTT â†’ Database â†’ Socket.io

Ini inti integrasi (kemungkinan sudah ada, tapi ini alurnya):

mqttClient.on("message", async (topic, message) => {
  const payload = JSON.parse(message.toString());

  // contoh
  const deviceId = topic.split("/")[2];

  // simpan/update database
  await db.update(devices)
    .set({
      status: payload.status,
      value: payload.value,
    })
    .where(eq(devices.id, Number(deviceId)));

  // kirim real-time ke frontend
  io.emit("device_update", {
    deviceId,
    ...payload,
  });
});


ðŸ“Œ Yang berubah di sini:

Data datang dari MQTT, bukan HTTP

Setelah update DB â†’ langsung broadcast Socket.io

âœ… D. Publish MQTT saat user control device

Tambahkan / pastikan handler Socket.io ini ada:

socket.on("control_device", (data) => {
  mqttClient.publish(
    `iot/control/${data.deviceId}`,
    JSON.stringify({
      status: data.status,
      value: data.value,
    })
  );
});


ðŸ“Œ Fungsi ini:

Web â†’ MQTT â†’ ESP32

Tombol di web = kontrol real device

2ï¸âƒ£ Database (Schema) â€” 1 perubahan kecil tapi penting
âŒ Sebelumnya
value: integer("value").notNull(),

âœ… Diubah jadi
value: real("value").notNull(),


Dan import real:

import { pgTable, text, serial, integer, boolean, timestamp, real } 
from "drizzle-orm/pg-core";


ðŸ“Œ Kenapa?

MQTT kirim data float (25.5, 18.3)

Integer bikin error (invalid input syntax)

3ï¸âƒ£ Frontend (ReactJS) â€” HAMPIR TIDAK BERUBAH
âœ… A. Tetap pakai Socket.io

Frontend tidak perlu tahu MQTT sama sekali.

Cukup:

socket.on("device_update", (device) => {
  // update state
  setDevices((prev) =>
    prev.map((d) =>
      d.id === device.deviceId ? { ...d, ...device } : d
    )
  );
});


ðŸ“Œ MQTT disembunyikan di backend
â†’ Frontend tetap bersih

âœ… B. Control device (tetap sama)
socket.emit("control_device", {
  deviceId: 1,
  status: "on",
  value: 100,
});


ðŸ“Œ Tidak berubah sama sekali